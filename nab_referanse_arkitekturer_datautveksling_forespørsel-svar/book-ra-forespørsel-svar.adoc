:lang: no
:doctitle: Mønstre for spørring og oppslag
:keywords: TBD
:toclevels: 3
include::../plattform_felles/includes/commonincludes.adoc[]

:leveloffset: +1

_Dette er en del  link:../nab_referanse_arkitekturer_datautveksling/[Referansearkitektur for datautveksling]_.


= Generisk mønster for spørring og oppslag
//image:../plattform_felles/media/i-arbeid.png[width=45, height=45] _I arbeid._


include::../nab_referanse_arkitekturer_forespørsel-svar-generisk/book-generisk-forespørsel-svar.adoc[]

= eOppslag - et løsningsmønster for oppslag i data gjennom synkrone API-kall

== eOppslag - generelt arkitekturmønster

eOppslag som arkitekturmønster beskriver synkrone API-kall mot en datatilbyder med tilgangsstyring ved bruk av sikkerhetsbilletter.

Her beskrives realiseringen av kapabilitetene i det generiske mønsteret for deling av data på forespørsel innenfor rammene av synkrone oppslag mot APIer og tilgangsstyring ved bruk av sikkerhetsbilletter.

Beskrivelsene er forsøkt å holdes generisk uten å peke til noen løsning og det vil dermed kunne være flere måter å realisere de ulike elementene på.


=== Klargjøring for _deling av data på forespørsel_

==== Tilgjengeliggjøre data

Tilgjengeliggjøring av API gjøres av tilbyder av data og er det tilbyder må gjennomføre for å gjøre et API synlig og tilgjengelig gjennom kataloger og søkeløsninger. Registrering av konsumenters rettigheter og tilganger inngår også som et prosessteg. 

Dersom det er registrering av et åpent API, er det kun relevante prossessteg som utføres.

image:../nab_referanse_arkitekturer_forespørsel-svar-generisk/media/ABB_Tilgjengeliggjøre.png[alt="Bilde mangler", link=https://nasjonal-arkitektur.github.io/nab_modeller_html-hovedbibliotek/e7e6c527-26f4-461c-b4dd-651fcbe85c8d/views/0134474e-0b53-4b7c-b4e2-cf2f2e957616.html]


[cols ="1,3", options="header"]
.Elementer i view for Tilgjengeliggjøre data
|===

| Element
| Beskrivelse

| Datatilbyder
| Tilbyder av data til andre aktører.

| Tilgjengeliggjøre data
| Evnen til å gjøre data tilgjengelig for aktører utenfor egen virksomhet.

| Bruksavtale
| Avtale om tilgang til og bruk av data. Dette kan for eksempel være en bilateralt utformet avtale, aksept av generelle bruksvilkår eller lisens for bruk av åpne data.

| Tilgjengeliggjøre API
| Prosessen med å tilby data gjennom et API til aktører utenfor egen virksomhet.

| Registrere API
| Prosess med å registere API i relevante tjenester, api-katalog, Maskinporten, Kapabilitetsoversikt

| Inngå avtale om tilgang til data
| Prosess for å inngå avtale om tilgang og bruk av data.

| Tildele tilganger til API
| Prosess for å registrere hvilke databrukere som skal få tilgang
Sette policy, og grov tilgangsstyring gjennom maskinporten.

| Registrere brukere av samtykke
| Prosess for å registrere konsumenter som skal ha mulighet for å innhente samtykker som gir tilgang til en tjeneste.

Dette utføres kun om det er behov for samtykke for tilgang til dataene.

| API-registreringstjeneste
| Tjeneste for å registerer de API-ene man ønsker å tilby til konsumenter og egenskaper ved disse.

| Registrering av API-brukere
| Tjeneste for gjennom selvbetjening å registrere og vedlikeholde tilgangene konsumenter skal ha til API-er og scopes.

| Registrere samtykkebasert tilgang
| Tjeneste for å registerer konsumenter som kan innhente samtykke som gir grunnlag for utlevering fra datatilbyder.

|===



==== Få tilgang til data
_Få tilgang til API_ er det en konsument av data må gjøre for å få tilgang til data gjennom et API. Det omfatter å få kjennskap til aktuelt API, inngå avtale om bruk av data, samt å registrere den tekniske komponenten som skal utføre tjenestekallet. Dersom det dreier seg om tilgang til et _åpent tilgjengelig_ API, kan enkelte delaktiviteter i prosessene hoppes over.


image:../nab_referanse_arkitekturer_forespørsel-svar-generisk/media/ABB_Tilgang.png[alt="Bilde mangler", width=750,link=https://nasjonal-arkitektur.github.io/nab_modeller_html-hovedbibliotek/e7e6c527-26f4-461c-b4dd-651fcbe85c8d/views/6c5a004d-da35-4fce-b38d-4b09d1167201.html]



[cols ="1,3", options="header"]
.Elementer i view for Få tilgang til data
|===

| Element
| Beskrivelse

| Datakonsument
| Den som innhenter eller mottar data fra andre aktører.

| Få tilgang til data (konsument)
| Evnen til å skaffe seg tilgang til tilbudte data fra annen aktør. 

| Bruksavtale
| Avtale om tilgang til og bruk av data. Dette kan for eksempel være en bilateralt utformet avtale, aksept av generelle bruksvilkår eller lisens for bruk av åpne data.

| Få tilgang til API
| Prosessen med å skaffe seg tilgang til tilbudte data fra annen aktør. Omfatte å finne API-er, inngå nødvendige avtaler og få tilganger.

| Finn/få kjennskap til API
| Prosessen med å finne eller få kjennskap til tilgjengelige API-er gjennom relevante kataloger og søkeløsninger.

| Inngå avtale om tilgang til data
| Prosess for å inngå avtale om tilgang og bruk av data.

| Registreringstjeneste for API-brukere
| Tjeneste for å registrere klienter som skal ha tilgang til et gitt API.

| API-søk
| Tjeneste for å søke etter og finne tilgjengelige API-er

| Registrer klient med tildelt tilgang
| Prosess for konsument å registerere (provisjonering av) den klienten som skal ha tilgang til API-et ved bruk av sikkerhetsbillett. Dette forutsetter at konsumenten har avtale om bruk av sikkerhetsbillettjenesten og at tilbyder har gitt konsumenten tilgang.

Dersom det er en leverandør som har blitt delegert rettigheter som databehandler på vegne av konsument er det leverandøren som registrer sin klient.

|===



==== Delegere rettigheter til databehandler
Delegering av rettigheter til databehandler er det en konsument må gjøre for at en leverandør kan identifisere seg med sitt eget virksomhetssertifikat og opptre på vegne av konsumenten som er den som innehar behandlingsgrunnlaget for å innhente data.

image:../nab_referanse_arkitekturer_forespørsel-svar-generisk/media/ABB_Delegering.png[alt="Bilde mangler", width=500,link=https://nasjonal-arkitektur.github.io/nab_modeller_html-hovedbibliotek/e7e6c527-26f4-461c-b4dd-651fcbe85c8d/views/7ad70658-c174-4da3-95e1-b0628688bcc1.html]


[cols ="1,3", options="header"]
.Elementer i view for Delegere rettigheter til databehandler
|===

| Element
| Beskrivelse

| Samhandlingsaktør
| Samlebetegnelse på roller som inngår i en samhandlingsprosess og samhandler med en annen samhandlingsaktør. Kan være en tilbyder, konsument, avsender, mottaker, leverandør etc.

| Delegere rettigheter til databehandler
| Evnen til å delegere rettigheter til databehandler som utfører oppgaver på vegne av behandlingsansvarlig.

| Tjenesteavtale
| Avtale mellom leverandør og konsument som er grunnlaget for å kunne delegere rettigheter fra konsument til en leverandør

| Delegering av rettigheter til databehandler (leverandør)
| Prosessen med å delegere rettigheter til databehandler/leverandør.

| Inngå avtale med leverandør
| Prosessen med å inngå en avtale med leverandør. En slik avtale vil normalt være inngått tidligere og uavhengig av om man skal ta i bruk et nytt API. En tjenesteavtale med leverandør er en forutsetning for å kunne delegere en tilgang.

| Registrere delegert tilgang
| Prosessen med å delegere tilganger. I tilknytning til eOppslag vil formålet være å gi leverandør tilgang til å representere konsument overfor et API, men registreringen vil potensielt også kunne gjelde for andre områder.

| Registering av representasjonsforhold
| Tjeneste for å registrere et representasjonsforhold som gir leverandør mulighet til å opptre på vegne av konsument

|===




=== Utveksling av data

==== Innhente data
Slå opp data gjennom et API er det en konsument må gjøre når det utføres et tjenestekall for å innhente data gjennom et API. Dersom det er et åpent API er det kun relevante prossessteg som utføres.

image:../nab_referanse_arkitekturer_forespørsel-svar-generisk/media/ABB_Innhente.png[alt="Bilde mangler",  link=https://nasjonal-arkitektur.github.io/nab_modeller_html-hovedbibliotek/e7e6c527-26f4-461c-b4dd-651fcbe85c8d/views/4742dd13-f1fe-4e78-80a8-80929a62efb9.html]


[cols ="1,3", options="header"]
.Elementer i view for Innhente data
|===

| Element
| Beskrivelse

| Datakonsument
| Den som innhenter eller mottar data fra andre aktører.

| Innhente data
| Evnen til å innhente data fra en annen aktør.

| Forespørsel om data
| Forespørsel om data med parametetere i forespørselen, sikkerhetsbillett mv.

| Slå opp data gjennom et API 
| Prosessen med å slå opp og hente data gjennom et API.

| Innhent samtykke ved behov
| Prosess for å innhente samtykke fra person eller virksomhet som grunnlag for å innhente data. Dette gjøres kun ved behov.

| Hent teknisk endepunkt ved behov
| Prosessen å slå opp den tekniske adressen til et API før spørring mot API-et. Gjøres kun dersom det er nødvendig.

| Be om tilgangstoken
| Prosessen med å benytte en sikkerhetsbillettjeneste for hente en sikkerhetsbillett som gir tilgang til et API. Dette forutsetter at alt er registert og satt opp riktig mot de aktuelle tjenestene.

| Utfør tjenestekall
| Prosessen med å benytte (gjøre et oppslag mot) et eksternt API.

| Samtykkeregistererings-tjeneste
| Tjeneste for å innhente samtykke fra den registrert som dataene gjelder. Dette kan være en person eller en virksomhet.

| Adressetjeneste
| Tjeneste som gir mulighet til å slå opp teknisk endepunkt

| Tokentjeneste
| Tjeneste som utsteder sikkerhetsbilletter. Sikkerhetsbillett utstedes basert på tildelte rettigheter og eventuelle representasjonsforhold.

| Datautvekslings-tjeneste
| Tjeneste for utveksling av data. Samme som data exchange service. Benyttes av avsender og mottaker for transport av meldinger.

|===



==== Avgi data
Avgi forespurte data er det tilbyder av data må gjøre for å svare på en forespørsel. Prosessen kontrollere tilgang gjøres kun dersom det er enakk om å avgi data gjennom et sikret API.


image:../nab_referanse_arkitekturer_forespørsel-svar-generisk/media/ABB_Avgi.png[alt="Bilde mangler", link=https://nasjonal-arkitektur.github.io/nab_modeller_html-hovedbibliotek/e7e6c527-26f4-461c-b4dd-651fcbe85c8d/views/c993199e-3879-4f72-967d-4339159f6641.html]


[cols ="1,3", options="header"]
.Elementer i view for Avgi data
|===

| Element
| Beskrivelse

| Datatilbyder
| Tilbyder av data til andre aktører.

| Avgi data
| Evne til å avgi data på forespørsel. Kan omfatte tilgangsstyring.

| Forespørsel
| Informasjon om det som forespørres.

| Autentiseringsdata
| Data som autentiserer konsument, f.eks. digitalt sertifikat eller sikkerhetsbillett.

| Autorisasjonsdata
| Data som autoriserer konsument, f.eks. påstander i en sikkerhetsbillett.

| Svar på forespørsel
| Informasjonen som avgis til konsument som svar på en forespørsel.

| Avgi forespurte data gjennom API
| Prosessen med å avgi data på forespørsel gjennom et egnet API.

| Motta  forespørsel om oppslag
| Motta forespørsler fra API-konsument om å avgi data.

| Autentisere konsument
| Prosessen med å autentisere en kosnument.

| Kontroller tilgang
| Kontroll og håndheving av konsumentens rettigheter til å få forespurte data.  I tillegg til "validering av sikkerhetsbillet", kan det være behov for kontroll mot virksomhetsinterne policies.

| Avgi data
| Prosessen med å gi svar på forespørselen.

| Datautvekslings-tjeneste
| Tjeneste for utveksling av data. Samme som data exchange service. Benyttes av avsender og mottaker for transport av meldinger.

| Autentiseringstjeneste
| Tjeneste som benyttes av tilbyder for å validere og kontrollere autentisiteten til et OAUTH2 token fra Maskinporten

| Tilgangskontroll-tjeneste
| Tjeneste for å sjekke rettigheter til data. Kan være eksterne eller interne tjenester.
Eksempler på rettigheter kan komme av samtykker fra person eller virksomhet, eller rollebasert fra vergemål, familierelasjon el.

| Datautvekslings-tjeneste
| Tjeneste for utveksling av data. Samme som data exchange service. Benyttes av avsender og mottaker for transport av meldinger.

|===

== eOppslag - løsningsmønster med bruk av nasjonale fellesløsninger

:leveloffset: +1
include::../nab_referanse_arkitekturer_eoppslag/book-eoppslag-referansearkitektur.adoc[]
:leveloffset: -1
////
= Asynkron spørring (request-reply)
image:../plattform_felles/media/i-arbeid.png[width=45, height=45] _I arbeid._
////
